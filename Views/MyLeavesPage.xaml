<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:conv="clr-namespace:PFE.Converters"
             xmlns:scheduler="clr-namespace:Syncfusion.Maui.Scheduler;assembly=Syncfusion.Maui.Scheduler"
             x:Class="PFE.Views.MyLeavesPage"
             Title="Mes cong&#233;s"
             BackgroundColor="#0F172A">

    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:StatusColorConverter x:Key="StatusColorConverter" />
            <conv:StringNotEmptyConverter x:Key="StringNotEmptyConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,*">
        
        <!-- Switch Liste/Calendrier -->
        <Frame Grid.Row="0"
               CornerRadius="12"
               Padding="12"
               BackgroundColor="#111827"
               BorderColor="#1F2937"
               HasShadow="False"
               Margin="20,20,20,0">
            <HorizontalStackLayout Spacing="12"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center">
                <Label x:Name="ListLabel"
                       Text="Liste"
                       FontSize="14"
                       FontAttributes="Bold"
                       TextColor="#60A5FA"
                       VerticalOptions="Center" />
                <Switch x:Name="ViewSwitch"
                        IsToggled="False"
                        Toggled="OnViewToggled"
                        OnColor="#3B82F6"
                        ThumbColor="White" />
                <Label x:Name="CalendarLabel"
                       Text="Calendrier"
                       FontSize="14"
                       TextColor="#9CA3AF"
                       VerticalOptions="Center" />
            </HorizontalStackLayout>
        </Frame>

        <!-- Stats Allocations - TOUJOURS VISIBLE -->
        <Frame x:Name="StatsFrame"
               Grid.Row="1"
               BackgroundColor="#111827"
               CornerRadius="12"
               HasShadow="True"
               Padding="16"
               Margin="20,16,20,0"
               BorderColor="#1F2937"
               IsVisible="True">
            <HorizontalStackLayout Spacing="20"
                                   HorizontalOptions="Center">
                <Frame BackgroundColor="#1E40AF"
                       CornerRadius="8"
                       Padding="16,12"
                       HasShadow="False"
                       BorderColor="Transparent">
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Allocations"
                               FontSize="12"
                               TextColor="#93C5FD"
                               HorizontalOptions="Center" />
                        <Label Text="{Binding TotalAllocated}"
                               FontSize="24"
                               FontAttributes="Bold"
                               TextColor="White"
                               HorizontalOptions="Center" />
                        <Label Text="jours"
                               FontSize="10"
                               TextColor="#93C5FD"
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </Frame>

                <Frame BackgroundColor="#991B1B"
                       CornerRadius="8"
                       Padding="16,12"
                       HasShadow="False"
                       BorderColor="Transparent">
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Pris"
                               FontSize="12"
                               TextColor="#FCA5A5"
                               HorizontalOptions="Center" />
                        <Label Text="{Binding TotalTaken}"
                               FontSize="24"
                               FontAttributes="Bold"
                               TextColor="White"
                               HorizontalOptions="Center" />
                        <Label Text="jours"
                               FontSize="10"
                               TextColor="#FCA5A5"
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </Frame>

                <Frame BackgroundColor="#166534"
                       CornerRadius="8"
                       Padding="16,12"
                       HasShadow="False"
                       BorderColor="Transparent">
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Restant"
                               FontSize="12"
                               TextColor="#86EFAC"
                               HorizontalOptions="Center" />
                        <Label Text="{Binding TotalRemaining}"
                               FontSize="24"
                               FontAttributes="Bold"
                               TextColor="White"
                               HorizontalOptions="Center" />
                        <Label Text="jours"
                               FontSize="10"
                               TextColor="#86EFAC"
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </Frame>
            </HorizontalStackLayout>
        </Frame>

        <!-- VUE LISTE -->
        <Grid x:Name="ListViewContainer"
              Grid.Row="2"
              Margin="20,16,20,20"
              RowDefinitions="Auto,Auto,Auto,*"
              IsVisible="True">

            <!-- Indicateur mode hors-ligne -->
            <Frame Grid.Row="0"
                   CornerRadius="10"
                   Padding="12"
                   BackgroundColor="#7F1D1D"
                   BorderColor="#DC2626"
                   HasShadow="False"
                   Margin="0,0,0,12"
                   IsVisible="{Binding IsOffline}">
                <HorizontalStackLayout Spacing="8"
                                       HorizontalOptions="Center">
                    <Label Text="Mode hors-ligne"
                           FontSize="14"
                           FontAttributes="Bold"
                           TextColor="#FCA5A5"
                           VerticalOptions="Center" />
                </HorizontalStackLayout>
            </Frame>

            <!-- Message de synchronisation -->
            <Frame Grid.Row="1"
                   CornerRadius="10"
                   Padding="12"
                   BackgroundColor="#14532D"
                   BorderColor="#22C55E"
                   HasShadow="False"
                   Margin="0,0,0,12"
                   IsVisible="{Binding SyncMessage, Converter={StaticResource StringNotEmptyConverter}}">
                <Label Text="{Binding SyncMessage}"
                       FontSize="14"
                       TextColor="#86EFAC"
                       HorizontalTextAlignment="Center" />
            </Frame>

            <!-- Filtres -->
            <Frame Grid.Row="2"
                   CornerRadius="16"
                   Padding="14"
                   BackgroundColor="#111827"
                   BorderColor="#1F2937"
                   HasShadow="True"
                   Margin="0,0,0,12">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Filtres"
                           TextColor="#E5E7EB"
                           FontSize="14"
                           FontAttributes="Bold" />

                    <Grid ColumnDefinitions="*,*"
                          ColumnSpacing="12">
                        <VerticalStackLayout Grid.Column="0"
                                             Spacing="4">
                            <Label Text="Annee"
                                   FontSize="12"
                                   TextColor="#9CA3AF" />
                            <Picker ItemsSource="{Binding Years}"
                                    ItemDisplayBinding="{Binding Label}"
                                    Title="Annee"
                                    SelectedItem="{Binding SelectedYearItem}"
                                    BackgroundColor="#020617"
                                    TextColor="White" />
                        </VerticalStackLayout>

                        <VerticalStackLayout Grid.Column="1"
                                             Spacing="4">
                            <Label Text="Statut"
                                   FontSize="12"
                                   TextColor="#9CA3AF" />
                            <Picker ItemsSource="{Binding Statuses}"
                                    ItemDisplayBinding="{Binding LabelFr}"
                                    Title="Statut"
                                    SelectedItem="{Binding SelectedStatusItem}"
                                    BackgroundColor="#020617"
                                    TextColor="White" />
                        </VerticalStackLayout>
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <!-- Liste des conges -->
            <CollectionView Grid.Row="3"
                            ItemsSource="{Binding Leaves}"
                            IsVisible="{Binding IsEmployee}">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical"
                                       ItemSpacing="12" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Margin="0,2"
                               Padding="14"
                               CornerRadius="18"
                               HasShadow="True"
                               BackgroundColor="#111827"
                               BorderColor="#1F2937">
                            <VerticalStackLayout Spacing="8">
                                <Label Text="{Binding Type}"
                                       FontAttributes="Bold"
                                       FontSize="15"
                                       TextColor="#E5E7EB" />

                                <Label Text="Periode"
                                       FontSize="11"
                                       TextColor="#6B7280" />

                                <HorizontalStackLayout Spacing="10">
                                    <Label Text="{Binding StartDate, StringFormat='Debut : {0:dd/MM/yyyy}'}"
                                           FontSize="13"
                                           TextColor="#D1D5DB" />
                                    <Label Text="{Binding EndDate, StringFormat='Fin : {0:dd/MM/yyyy}'}"
                                           FontSize="13"
                                           TextColor="#D1D5DB" />
                                </HorizontalStackLayout>

                                <Label Text="{Binding Days, StringFormat='Duree : {0} jours'}"
                                       FontSize="13"
                                       TextColor="#9CA3AF" />

                                <VerticalStackLayout Spacing="4"
                                                     Margin="0,4,0,0">
                                    <Label Text="Statut"
                                           FontSize="11"
                                           TextColor="#6B7280" />
                                    <Frame Padding="8,4"
                                           CornerRadius="999"
                                           BorderColor="Transparent"
                                           HasShadow="False"
                                           BackgroundColor="{Binding Status, Converter={StaticResource StatusColorConverter}}">
                                        <Label Text="{Binding Status}"
                                               FontSize="11"
                                               FontAttributes="Bold"
                                               TextColor="White"
                                               HorizontalOptions="Center" />
                                    </Frame>
                                </VerticalStackLayout>
                            </VerticalStackLayout>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <VerticalStackLayout Spacing="12"
                                         VerticalOptions="Center"
                                         HorizontalOptions="Center">
                        <Label Text="{Binding ListErrorMessage}"
                               FontSize="14"
                               TextColor="#F97373"
                               HorizontalTextAlignment="Center"
                               LineBreakMode="WordWrap"
                               IsVisible="{Binding ListErrorMessage, Converter={StaticResource StringNotEmptyConverter}}" />

                        <ActivityIndicator IsRunning="{Binding IsListBusy}"
                                           IsVisible="{Binding IsListBusy}"
                                           Color="#60A5FA"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </Grid>

        <!-- VUE CALENDRIER -->
        <Frame x:Name="CalendarViewContainer"
               Grid.Row="2"
               Margin="20,16,20,20"
               BackgroundColor="#111827"
               CornerRadius="16"
               HasShadow="True"
               Padding="12"
               BorderColor="#1F2937"
               IsVisible="False">

            <scheduler:SfScheduler x:Name="Scheduler"
                                   View="Month"
                                   FirstDayOfWeek="Monday"
                                   BackgroundColor="#111827"
                                   AllowedViews="Week,Month"
                                   AppointmentsSource="{Binding Appointments}"
                                   Tapped="OnSchedulerTapped"
                                   ShowBusyIndicator="{Binding IsCalendarBusy}">

                <scheduler:SfScheduler.AppointmentMapping>
                    <scheduler:SchedulerAppointmentMapping
                        Subject="Subject"
                        StartTime="StartTime"
                        EndTime="EndTime"
                        Background="Background"
                        IsAllDay="IsAllDay"/>
                </scheduler:SfScheduler.AppointmentMapping>

                <scheduler:SfScheduler.HeaderView>
                    <scheduler:SchedulerHeaderView Background="#111827"
                                                   TextStyle="{scheduler:SchedulerTextStyle TextColor=White, FontSize=18}" />
                </scheduler:SfScheduler.HeaderView>

                <scheduler:SfScheduler.MonthView>
                    <scheduler:SchedulerMonthView AppointmentDisplayMode="Text"
                                                  NavigationDirection="Vertical">
                        <scheduler:SchedulerMonthView.ViewHeaderSettings>
                            <scheduler:SchedulerViewHeaderSettings DayFormat="ddd"
                                                                   DayTextStyle="{scheduler:SchedulerTextStyle TextColor=#9CA3AF, FontSize=12}" />
                        </scheduler:SchedulerMonthView.ViewHeaderSettings>
                        <scheduler:SchedulerMonthView.CellStyle>
                            <scheduler:SchedulerMonthCellStyle TextStyle="{scheduler:SchedulerTextStyle TextColor=White, FontSize=14}"
                                                               TrailingMonthTextStyle="{scheduler:SchedulerTextStyle TextColor=#4B5563, FontSize=12}"
                                                               LeadingMonthTextStyle="{scheduler:SchedulerTextStyle TextColor=#4B5563, FontSize=12}"
                                                               Background="Transparent"/>
                        </scheduler:SchedulerMonthView.CellStyle>
                    </scheduler:SchedulerMonthView>
                </scheduler:SfScheduler.MonthView>

                <scheduler:SfScheduler.DaysView>
                    <scheduler:SchedulerDaysView>
                        <scheduler:SchedulerDaysView.ViewHeaderSettings>
                            <scheduler:SchedulerViewHeaderSettings DayFormat="ddd"
                                                                   DateFormat="dd"
                                                                   DayTextStyle="{scheduler:SchedulerTextStyle TextColor=#9CA3AF, FontSize=12}"
                                                                   DateTextStyle="{scheduler:SchedulerTextStyle TextColor=White, FontSize=14}" />
                        </scheduler:SchedulerDaysView.ViewHeaderSettings>
                    </scheduler:SchedulerDaysView>
                </scheduler:SfScheduler.DaysView>

            </scheduler:SfScheduler>
        </Frame>
    </Grid>
</ContentPage>
