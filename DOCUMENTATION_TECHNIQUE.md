# Documentation Technique - ATimeOff

## ?? Table des matières

1. [Vue d'ensemble](#vue-densemble)
2. [Architecture du projet](#architecture-du-projet)
3. [Technologies utilisées](#technologies-utilisées)
4. [Structure des dossiers](#structure-des-dossiers)
5. [Modèles de données](#modèles-de-données)
6. [Services](#services)
7. [ViewModels (MVVM)](#viewmodels-mvvm)
8. [Vues](#vues)
9. [Fonctionnalités offline](#fonctionnalités-offline)
10. [Système de notifications](#système-de-notifications)
11. [Sécurité et authentification](#sécurité-et-authentification)
12. [Configuration](#configuration)

---

## Vue d'ensemble

**ATimeOff** est une application mobile/desktop multi-plateforme développée en **.NET MAUI** pour la gestion des congés. Elle se connecte à un backend **Odoo** via son API JSON-RPC et offre un mode hors-ligne complet grâce à une base de données **SQLite** locale.

### Fonctionnalités principales

| Fonctionnalité | Employé | Manager |
|----------------|---------|---------|
| Consulter ses congés | ? | ? |
| Demander un congé | ? | ? |
| Approuver/Refuser des congés | ? | ? |
| Recevoir des notifications | ? | ? |
| Mode hors-ligne | ? | ? |
| Synchronisation automatique | ? | ? |

---

## Architecture du projet

L'application suit le pattern **MVVM (Model-View-ViewModel)** avec injection de dépendances.

```
???????????????????????????????????????????????????????????????
?                         VIEWS (XAML)                        ?
?  LoginPage, DashboardPage, LeavesPage, ManageLeavesPage... ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
?                        VIEWMODELS                           ?
?  AuthenticationViewModel, LeaveViewModel, LeaveRequest...   ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
?                         SERVICES                            ?
?  OdooClient, DatabaseService, SyncService, OfflineService   ?
???????????????????????????????????????????????????????????????
                              ?
              ?????????????????????????????????
              ?                               ?
???????????????????????????     ???????????????????????????
?      ODOO API           ?     ?     SQLite LOCAL        ?
?   (JSON-RPC HTTP)       ?     ?   (Cache & Offline)     ?
???????????????????????????     ???????????????????????????
```

---

## Technologies utilisées

### Framework principal
| Technologie | Version | Description |
|-------------|---------|-------------|
| .NET | 9.0 | Framework de développement |
| .NET MAUI | 9.0.120 | Framework UI multi-plateforme |
| C# | 13.0 | Langage de programmation |

### Plateformes cibles
- **Windows** 10.0.19041+
- **Android** 21.0+
- **iOS** 15.0+
- **macOS Catalyst** 15.0+

### Packages NuGet

| Package | Version | Utilisation |
|---------|---------|-------------|
| `sqlite-net-pcl` | 1.9.172 | Base de données locale SQLite |
| `SQLitePCLRaw.bundle_green` | 2.1.10 | Provider SQLite natif |
| `Syncfusion.Maui.Calendar` | 31.2.18 | Composant calendrier |
| `Syncfusion.Maui.Scheduler` | 31.2.18 | Composant planificateur |
| `Plugin.LocalNotification` | 11.1.4 | Notifications locales |
| `DotNetEnv` | 3.1.1 | Gestion des variables d'environnement |
| `Microsoft.Extensions.Http` | 10.0.0 | HttpClient factory |
| `Microsoft.Toolkit.Uwp.Notifications` | 7.1.3 | Notifications Windows |

---

## Structure des dossiers

```
PFE/
??? App.xaml.cs                 # Point d'entrée, gestion du cycle de vie
??? MauiProgram.cs              # Configuration DI et services
??? PFE.csproj                  # Configuration du projet
??? .env                        # Variables d'environnement (secrets)
?
??? Context/
?   ??? SessionContext.cs       # Contexte de session utilisateur
?
??? Converters/                 # Convertisseurs XAML
?   ??? StatusColorConverter.cs
?   ??? StringNotEmptyConverter.cs
?   ??? InverseBoolConverter.cs
?   ??? ...
?
??? Helpers/                    # Classes utilitaires
?   ??? DateHelper.cs
?   ??? LeaveStatusHelper.cs
?   ??? LeaveTypeHelper.cs
?   ??? JsonValidation.cs
?
??? Models/                     # Modèles de données
?   ??? Leave.cs
?   ??? LeaveToApprove.cs
?   ??? LeaveTypeItem.cs
?   ??? AllocationSummary.cs
?   ??? SessionUser.cs
?   ??? UserProfile.cs
?   ??? Database/              # Modèles SQLite
?       ??? CachedLeave.cs
?       ??? CachedLeaveType.cs
?       ??? CachedAllocationSummary.cs
?       ??? PendingLeaveRequest.cs
?       ??? PendingLeaveDecision.cs
?       ??? UserSession.cs
?       ??? ...
?
??? Services/                   # Couche service
?   ??? OdooClient.cs          # Client API Odoo
?   ??? DatabaseService.cs     # Service SQLite
?   ??? SyncService.cs         # Synchronisation offline
?   ??? OfflineService.cs      # Gestion mode offline
?   ??? BackgroundNotificationService.cs
?   ??? BackgroundLeaveStatusService.cs
?
??? ViewModels/                 # ViewModels MVVM
?   ??? AuthenticationViewModel.cs
?   ??? LeaveViewModel.cs
?   ??? LeaveRequestViewModel.cs
?   ??? ManageLeavesViewModel.cs
?   ??? CalendarViewModel.cs
?   ??? ...
?
??? Views/                      # Pages XAML
?   ??? LoginPage.xaml
?   ??? DashboardPage.xaml
?   ??? LeavesPage.xaml
?   ??? LeaveRequestPage.xaml
?   ??? ManageLeavesPage.xaml
?   ??? CalendarPage.xaml
?   ??? ...
?
??? Resources/
    ??? AppIcon/               # Icône de l'application
    ??? Fonts/                 # Polices personnalisées
    ??? Images/                # Images
    ??? Raw/                   # Ressources brutes
```

---

## Modèles de données

### Modèles métier (API Odoo)

#### `Leave` - Congé
```csharp
public record Leave(
    int Id,
    string Type,           // Type de congé (ex: "Congés payés")
    DateTime StartDate,
    DateTime EndDate,
    string Status,         // Statut (Brouillon, En attente, Validé, Refusé)
    int Days,              // Nombre de jours
    string? FirstApprover  // Nom du premier approbateur
);
```

#### `LeaveToApprove` - Congé à approuver (Manager)
```csharp
public record LeaveToApprove(
    int Id,
    string EmployeeName,
    string Type,
    DateTime StartDate,
    DateTime EndDate,
    int Days,
    string Status,
    string Reason,
    bool CanValidate,
    bool CanRefuse
);
```

#### `AllocationSummary` - Résumé des allocations
```csharp
public record AllocationSummary(
    int LeaveTypeId,
    string LeaveTypeName,
    int TotalAllocated,    // Jours alloués
    int TotalTaken,        // Jours pris
    int TotalRemaining     // Jours restants
);
```

#### `SessionUser` - Utilisateur connecté
```csharp
public record SessionUser(
    int? UserId = null,
    bool IsAuthenticated = false,
    bool IsManager = false,
    int? EmployeeId = null
);
```

### Modèles SQLite (Cache local)

#### `CachedLeave` - Cache des congés
```csharp
[Table("cached_leaves")]
public class CachedLeave
{
    [PrimaryKey]
    public int LeaveId { get; set; }
    public int EmployeeId { get; set; }
    public string LeaveType { get; set; }
    public DateTime StartDate { get; set; }
    public DateTime EndDate { get; set; }
    public string Status { get; set; }
    public int Days { get; set; }
    public int? Year { get; set; }
    public DateTime CachedAt { get; set; }
}
```

#### `PendingLeaveRequest` - Demandes en attente de sync
```csharp
[Table("pending_leave_requests")]
public class PendingLeaveRequest
{
    [PrimaryKey, AutoIncrement]
    public int Id { get; set; }
    public int EmployeeId { get; set; }
    public int LeaveTypeId { get; set; }
    public DateTime StartDate { get; set; }
    public DateTime EndDate { get; set; }
    public string Reason { get; set; }
    public SyncStatus SyncStatus { get; set; }
    public DateTime CreatedAt { get; set; }
}
```

#### `PendingLeaveDecision` - Décisions en attente de sync
```csharp
[Table("pending_leave_decisions")]
public class PendingLeaveDecision
{
    [PrimaryKey, AutoIncrement]
    public int Id { get; set; }
    public int ManagerUserId { get; set; }
    public int LeaveId { get; set; }
    public string DecisionType { get; set; }  // "approve" ou "refuse"
    public SyncStatus SyncStatus { get; set; }
    public DateTime DecisionDate { get; set; }
}
```

---

## Services

### `OdooClient` - Client API Odoo

Service principal de communication avec le backend Odoo via l'API JSON-RPC.

#### Méthodes principales

| Méthode | Description |
|---------|-------------|
| `LoginAsync(login, password)` | Authentification utilisateur |
| `GetLeavesAsync(states)` | Récupérer les congés de l'employé |
| `GetLeavesToApproveAsync()` | Récupérer les demandes à approuver (Manager) |
| `CreateLeaveRequestAsync(...)` | Créer une demande de congé |
| `ApproveLeaveAsync(leaveId)` | Approuver un congé |
| `RefuseLeaveAsync(leaveId)` | Refuser un congé |
| `GetAllocationsSummaryAsync()` | Récupérer le solde des allocations |
| `HasOverlappingLeaveAsync(start, end)` | Vérifier les chevauchements |

#### Configuration
```csharp
// URL et DB configurés via .env
string OdooUrl = Environment.GetEnvironmentVariable("ODOO_URL");
string OdooDb = Environment.GetEnvironmentVariable("ODOO_DB");
```

### `DatabaseService` - Service SQLite

Gestion de la base de données locale SQLite pour le cache et le mode offline.

#### Tables gérées

| Table | Description |
|-------|-------------|
| `cached_leaves` | Cache des congés |
| `cached_leave_types` | Cache des types de congés |
| `cached_allocation_summaries` | Cache des allocations |
| `cached_blocked_dates` | Dates bloquées (calendrier) |
| `pending_leave_requests` | Demandes en attente de sync |
| `pending_leave_decisions` | Décisions en attente de sync |
| `user_session` | Session utilisateur (mode offline) |
| `seen_leave_notifications` | Notifications déjà vues |

### `SyncService` - Service de synchronisation

Gère la synchronisation bidirectionnelle entre l'app et Odoo.

#### Fonctionnement
1. **Boucle de synchronisation** : Vérifie toutes les 10 secondes
2. **Détection de connectivité** : Réagit aux changements de réseau
3. **Ré-authentification automatique** : Si la session expire
4. **Retry avec backoff** : En cas d'erreur réseau

```csharp
// Événements
event EventHandler<int>? DecisionsSynced;  // Décisions synchronisées
event EventHandler<int>? RequestsSynced;   // Demandes synchronisées
event EventHandler? SyncCompleted;         // Sync terminée
```

### `OfflineService` - Gestion du mode offline

Gère l'ajout des demandes/décisions en mode offline.

```csharp
// Ajouter une demande offline
await offlineService.AddPendingAsync(pendingRequest);

// Récupérer les demandes en attente
List<PendingLeaveRequest> pending = await offlineService.GetAllPendingAsync();
```

---

## ViewModels (MVVM)

### `AuthenticationViewModel`
- Gestion de la connexion/déconnexion
- Validation des credentials
- Option "Se souvenir de moi"

### `LeaveViewModel`
- Affichage de la liste des congés
- Filtrage par année et statut
- Chargement depuis cache en mode offline

### `LeaveRequestViewModel`
- Création d'une demande de congé
- Sélection des dates (calendrier)
- Validation des chevauchements
- Support du mode offline

### `ManageLeavesViewModel` (Manager)
- Liste des demandes à approuver
- Actions approuver/refuser
- Décisions offline avec sync automatique

### `CalendarViewModel`
- Vue calendrier des congés
- Dates bloquées visuellement
- Intégration Syncfusion Calendar

---

## Vues

### Pages principales

| Page | Rôle | Description |
|------|------|-------------|
| `LoginPage` | Tous | Authentification |
| `DashboardPage` | Tous | Page d'accueil avec navigation |
| `LeavesPage` | Employé | Liste des congés (vue liste) |
| `CalendarPage` | Employé | Vue calendrier des congés |
| `LeaveRequestPage` | Employé | Formulaire de demande |
| `ManageLeavesPage` | Manager | Gestion des approbations |
| `UserProfilePage` | Tous | Profil et paramètres |

### Navigation

```
LoginPage
    ?
    ?
DashboardPage ?????????????????????????????????????????????
    ?              ?                                      ?
    ?              ?                                      ?
[Employé]      [Manager]                            [Commun]
    ?              ?                                      ?
    ?? LeavesPage  ?? ManageLeavesPage             UserProfilePage
    ?? CalendarPage
    ?? LeaveRequestPage
```

---

## Fonctionnalités offline

### Principe de fonctionnement

```
???????????????????????????????????????????????????????????????
?                    MODE ONLINE                              ?
?  ???????????     ???????????     ???????????              ?
?  ?  User   ???????  App    ???????  Odoo   ?              ?
?  ???????????     ???????????     ???????????              ?
?                       ?                                     ?
?                       ?                                     ?
?                  ???????????                               ?
?                  ? SQLite  ? ??? Cache pour offline        ?
?                  ???????????                               ?
???????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????
?                    MODE OFFLINE                             ?
?  ???????????     ???????????     ???????????              ?
?  ?  User   ???????  App    ?     ?  Odoo   ? ? Offline    ?
?  ???????????     ???????????     ???????????              ?
?                       ?                                     ?
?                       ?                                     ?
?                  ???????????                               ?
?                  ? SQLite  ? ??? Lecture du cache          ?
?                  ???????????     + Stockage des actions    ?
???????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????
?                  RETOUR ONLINE                              ?
?                                                             ?
?  SyncService détecte la connexion                          ?
?       ?                                                     ?
?       ?                                                     ?
?  Ré-authentification automatique                           ?
?       ?                                                     ?
?       ?                                                     ?
?  Synchronisation des actions en attente                    ?
?       ?                                                     ?
?       ?                                                     ?
?  Notification à l'utilisateur                              ?
???????????????????????????????????????????????????????????????
```

### Données cachées

| Donnée | Durée de vie | Mise à jour |
|--------|--------------|-------------|
| Congés | Jusqu'au prochain online | À chaque chargement online |
| Types de congés | Jusqu'au prochain online | À chaque chargement online |
| Allocations | Jusqu'au prochain online | À chaque chargement online |
| Session utilisateur | Persistante | À chaque connexion |

---

## Système de notifications

### Notifications locales

L'application utilise `Plugin.LocalNotification` pour les notifications.

#### Pour les Employés
- Notification quand un congé est **validé**
- Notification quand un congé est **refusé**

#### Pour les Managers
- Notification quand une nouvelle **demande** arrive
- Badge avec le nombre de demandes en attente

### Services de notification

```csharp
// BackgroundLeaveStatusService (Employés)
// Vérifie périodiquement les changements de statut des congés

// BackgroundNotificationService (Managers)
// Vérifie périodiquement les nouvelles demandes à approuver
```

---

## Sécurité et authentification

### Stockage des credentials

| Donnée | Stockage | Sécurité |
|--------|----------|----------|
| Login | `Preferences` | Non chiffré |
| Mot de passe | `SecureStorage` | Chiffré par l'OS |
| Session Odoo | Cookies HTTP | Durée de vie limitée |
| Session locale | SQLite | Persistante |

### Flux d'authentification

```
???????????????????????????????????????????????????????????????
?                     DÉMARRAGE APP                           ?
???????????????????????????????????????????????????????????????
                           ?
                           ?
              ??????????????????????????
              ?  RememberMe activé ?   ?
              ??????????????????????????
                    ?           ?
                   Oui         Non
                    ?           ?
                    ?           ?
         ???????????????????  ???????????????????
         ? Connexion Odoo  ?  ? Session locale? ?
         ???????????????????  ???????????????????
              ?      ?              ?       ?
           Succès  Échec          Oui     Non
              ?      ?              ?       ?
              ?      ?              ?       ?
         Dashboard  Session     Dashboard  LoginPage
                   locale?
```

### Gestion de session expirée

1. Détection via erreur API ("Session expired")
2. Tentative de ré-authentification automatique
3. Si échec : redirection vers LoginPage

---

## Configuration

### Variables d'environnement (`.env`)

```env
ODOO_URL=https://votre-instance.odoo.com
ODOO_DB=nom_de_la_base
SYNCFUSION_LICENSE_KEY=votre_clé_syncfusion
```

### Configuration du projet (`.csproj`)

```xml
<!-- Nom de l'application -->
<ApplicationTitle>ATimeOff</ApplicationTitle>

<!-- Identifiant unique -->
<ApplicationId>com.companyname.atimeoff</ApplicationId>

<!-- Version -->
<ApplicationDisplayVersion>1.0</ApplicationDisplayVersion>
```

### Injection de dépendances (`MauiProgram.cs`)

```csharp
// Services Singleton
builder.Services.AddSingleton<IDatabaseService, DatabaseService>();
builder.Services.AddSingleton<OdooClient>();
builder.Services.AddSingleton<ISyncService, SyncService>();
builder.Services.AddSingleton<OfflineService>();
builder.Services.AddSingleton<SessionContext>();

// ViewModels Transient
builder.Services.AddTransient<LeaveViewModel>();
builder.Services.AddTransient<LeaveRequestViewModel>();
builder.Services.AddTransient<ManageLeavesViewModel>();

// Pages Transient
builder.Services.AddTransient<LoginPage>();
builder.Services.AddTransient<DashboardPage>();
builder.Services.AddTransient<LeavesPage>();
```

---

## Diagramme de classes simplifié

```
???????????????????????????????????????????????????????????????
?                        App.xaml.cs                          ?
?  - Cycle de vie                                             ?
?  - Auto-login                                               ?
?  - Événements de sync                                       ?
???????????????????????????????????????????????????????????????
                           ?
          ???????????????????????????????????
          ?                ?                ?
   ???????????????  ???????????????  ???????????????
   ? OdooClient  ?  ?DatabaseSvc ?  ? SyncService ?
   ???????????????  ???????????????  ???????????????
   ? LoginAsync  ?  ? SaveLeaves ?  ? Start/Stop  ?
   ? GetLeaves   ?  ? GetLeaves  ?  ? SyncNow     ?
   ? CreateLeave ?  ? SavePending?  ? IsOnline    ?
   ? Approve     ?  ? GetPending ?  ?             ?
   ???????????????  ???????????????  ???????????????
          ?                ?                ?
          ???????????????????????????????????
                           ?
                  ???????????????????
                  ?   ViewModels    ?
                  ???????????????????
                  ? LeaveViewModel  ?
                  ? RequestViewModel?
                  ? ManageViewModel ?
                  ???????????????????
                           ?
                           ?
                  ???????????????????
                  ?     Views       ?
                  ???????????????????
                  ? LeavesPage      ?
                  ? RequestPage     ?
                  ? ManagePage      ?
                  ???????????????????
```

---

## Auteur

Projet réalisé dans le cadre du PFE (Projet de Fin d'Études).

**Application** : ATimeOff  
**Version** : 1.0  
**Framework** : .NET MAUI 9.0  
**Backend** : Odoo (API JSON-RPC)
